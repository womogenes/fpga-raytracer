# RAYTRACER: Real-time A+-qualitY TRiangle And CirclE Renderer

## 6.2050 Final Project Code Provenance Report

**Calvin Rodrigue (`calvinr`) and William Feng (`wyf`)**  
Fall 2025

All files were written by us during the final project period unless otherwise specified. Some files are also ultimately unused so we don't mention them here.

## `./`

- `build_rtx.tcl` — tcl file used by Vivado to synth our design. Glob patterns were modified to fit our project structure and the new Nexys board.

## `xdc/`

- `top_level.xdc` — constraints file for our build. Some parts were taken from Nexys video repository:  
  https://github.com/Digilent/digilent-xdc/blob/master/Nexys-Video-Master.xdc

## `hdl/`

- `pipeline.sv` — parametric pipeline implementation with generic width and depth, written for lab 6.
- `constants.sv` — parameters for whole system, e.g. max scene buffer depth and floating point format. FP constants generated by `ctrl/find_constants.py`.
- `types/types.sv` — bit formats for floats, objects, materials, etc.
- `top_level_rtx.sv` — our toplevel file that wires up the high definition frame buffer, raytracing engine, and UART flashing system. Some components sourced from the lab 6 top level file.

### `hdl/dram/`

- `clockdomain_fifo.sv` — outgoing FIFO from the traffic generator to the HDMI signal. Based on material from lab 6.
- `clockdomain_addr_fifo.sv` — incoming FIFO from rtx engine to the traffic generator. Less wide than than addr_fifo, conveys rendered pixel data.
- `command_fifo.sv` — parametric LUT fifo used four times in traffic generator. Written for lab 6.
- `cw_hdmi_clk_wiz.v` — given during one of the labs for HDMI output.
- `ddr3_*.sv` — UberDDR3 IP to control DRAM chip, sourced from lab 6 materials.
- `evt_counter.sv` — event counter from past lab used in traffic generator.
- `high_definition_frame_buffer.sv` — heavily modified version of lab 6 HD frame buffer that can average frame values over time.
- `other *.v files` — stuff given to us from lab 6.
- `unstacker.sv` — used for reading out DRAM data for HDMI display, from lab 6.
- `traffic_generator.sv` — command module for DRAM that manages two frame buffers, one for accumulated pixel values and the other for HDMI output. Based off lab 6 file.

### `hdl/hdmi/`

- `*.sv` — HDMI output files including TMDS implementation and video signal generator, copied and unmodified from our lab 6.

### `hdl/math/`

- `clz.sv` — parametric module find the number of leading zeros of a constant-width value.
- `fp_add.sv` — floating-point addition module.
- `fp_convert.sv` — modules for converting between fixed-point and floating-point numbers.
- `fp_inv_sqrt.sv` — module for computing `1/sqrt(x)` given a floating-point number `x`. Used for normalizing vectors.
- `fp_inv.sv` — module for computing `1/x` given a floating-point number `x`. Used in triangle intersector.
- `fp_mul.sv` — floating-point multiplication module.
- `fp_shift.sv` — module for multiplying floats by a power of two. Uses fewer resources than `fp_mul.sv`.
- `fp_vec3_ops.sv` — implements all vector operations, including addition, multiplication, scaling, dot product, normalization, etc.
- `quadratic_solver.sv` — module to compute the smaller root of a monic quadratic. Used in sphere intersector.
- `specular_reflect.sv` — module to reflect a ray given surface normal using incidence rule. Used for specular reflections.
- `sphere_intersector.sv` — module to compute the nearest intersection between a ray and a sphere, if it exists.
- `trig_intersector.sv` — module to compute the intersection between a ray and a triangle/parallelogram/plane, if it exists.

### `hdl/mem/`

- `frame_buffer.sv` — unused BRAM buffer.
- `xilinx_*ram*.v` — Xilinx ram module IP for single- and dual-port BRAM, given to us in labs.

### `hdl/rng/`

- `prng_sphere.sv` — module to generate random points on a sphere. Used in diffuse reflections.
- `prng8.sv` — module to generate random 8-bit numbers, used for deciding specular reflections.
- `ring_osc_sampler.sv` — module to generate random bits using unstable ring oscillators.

### `hdl/rtx/`

- `material_dictionary.sv` — BRAM memory module that maps 8-bit material indices to materials.
- `ray_caster.sv` — video signal generator-like module that produces rays from the camera.
- `ray_intersector.sv` — fully pipelined module that combines `sphere_intersector` and `trig_intersector` to calculate arbitrary intersections between ray and scene.
- `ray_maker.sv` — module that calculates single ray direction given pixel coordinates and camera spec.
- `ray_reflector.sv` — module that calculates diffuse and specular reflections (direction + color). Uses rng modules.
- `ray_signal_gen.sv` — generates pixel coordinates.
- `ray_tracer.sv` — combines ray_intersector and ray_reflector to trace a ray fully from camera to expiration.
- `rtx_tb_parallel.sv` — runs the full rtx module without ray caster so that an external testbench can run only chunks at a time for faster rendering.
- `rtx_tb.sv` — runs rtx with scene buffer and material dictionary.
- `scene_buffer.sv` — wrapper for BRAM module that outputs one object at a time for the intersector.

### `hdl/seven_seg/`

- `*.sv` — used in an earlier iteration to control the seven-segment displays on the Urbana boards for debugging. Written in earlier labs.

### `hdl/uart/`

- `uart.sv` — module to receive UART signals, written in the UART lab.
- `uart_memflash_rtx` — module to take UART byte and valid signals and output multi-byte sequences for flashing camera, scene, etc.

## `data/`

- `scene_buffer.mem` (not version controlled) — generated by `ctrl/make_scene_buffer.py`, stores hex description of a scene for BRAM flashing.
- `mat_dict.mem` (not version controlled) — also generated by `ctrl/make_scene_buffer.py`, stores map from material index to full material properties.

---

## `sim/`

Testbenches exist for pretty much all our modules.

- `utils.py` — contains utilities for converting between Python numbers and floats in our format. Carries a lot of the weight in the testbenching/Python interfacing.

### `sim/math/fp_ops/`

- `test_fp_add.py`, `test_fp_inv_sqrt.py`, `test_fp_inv.py`, `test_fp_mul.py`, `test_fp_sqrt.py` — testbench corresponding modules using numpy.
- `test_fp_vec3_*.py` — testbench vector operations.
- `test_make_fp.py`, `test_convert_fp_uint.py` — testbench modules in `fp_convert.sv`.

### `sim/rng/`

- `test_prng_sphere.sv` — tests prng sphere module, visualizes using matplotlib.
- `test_prng8.sv` — tests prng8 module.

### `sim/rtx/`

- `test_quadratic_solver.py`, `test_ray_caster.py`, `test_ray_intersector.py`, `test_ray_reflector.py`, `test_specular_reflect.py` — test corresponding modules using math and visualizations.
- `test_sphere_intersector.py`, `test_trig_intersector.py` — test sphere and triangle intersection modules.
- `test_rtx.py` — single-threaded testbench for rtx module.
- `test_rtx_parallel.py` — multi-threaded testbench using verilator precompilation for faster rendering.
- `test_uart_memflash.py` — tests UART flashing module.

## `ctrl/`

- `scenes/*.json` — descriptions of various test scenes to flash to the board. Some 3D models (knight, pawn) obtained from poly.pizza.
- `find_constants.py` — utility script to determine magic bithack constants for inverse square root and reciprocal modules.
- `make_scene_buffer.py` — converts JSON scenes into binary representations for SRAM initialization and UART flashing.
- `flash_scene.py` — flashes scene data over UART to the FPGA.

## `sw_raytrace/`

Implementation of ray tracer in C to verify our understanding of the math. Contains multiple C files.
